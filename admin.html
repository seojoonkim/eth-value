<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETHval Admin - Data Verification</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        :root {
            --bg: #0a0a0f;
            --bg-card: #12121a;
            --bg-hover: #1a1a25;
            --border: #2a2a3a;
            --text: #e5e5e5;
            --text-muted: #888;
            --primary: #8b5cf6;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        .header h1 {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .badge {
            background: var(--primary);
            color: white;
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }
        .header-actions { display: flex; gap: 12px; align-items: center; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #7c3aed; }
        .btn-secondary { background: var(--bg-card); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--bg-hover); }
        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
        }
        .connection-status.connected { border-color: var(--success); color: var(--success); }
        .connection-status.disconnected { border-color: var(--error); color: var(--error); }

        /* Stats Summary */
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
        }
        .stat-card .label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
        .stat-card .value { font-size: 28px; font-weight: 700; }
        .stat-card .value.success { color: var(--success); }
        .stat-card .value.warning { color: var(--warning); }
        .stat-card .value.error { color: var(--error); }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }
        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }
        .chart-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chart-header h3 {
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chart-header .icon { font-size: 18px; }
        .chart-meta {
            display: flex;
            gap: 16px;
            font-size: 12px;
        }
        .chart-meta span { color: var(--text-muted); }
        .chart-meta .value { color: var(--text); font-weight: 500; font-family: 'JetBrains Mono', monospace; }
        .chart-body {
            padding: 16px;
            height: 280px;
            position: relative;
        }
        .chart-body canvas { width: 100% !important; height: 100% !important; }
        .chart-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 12px 20px;
            background: var(--bg);
            border-top: 1px solid var(--border);
        }
        .chart-stat { text-align: center; }
        .chart-stat .label { font-size: 10px; color: var(--text-muted); margin-bottom: 2px; }
        .chart-stat .value { font-size: 14px; font-weight: 600; font-family: 'JetBrains Mono', monospace; }
        .chart-stat .value.latest { color: var(--primary); }
        .chart-stat .value.min { color: var(--error); }
        .chart-stat .value.max { color: var(--success); }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot.success { background: var(--success); }
        .status-dot.partial { background: var(--warning); }
        .status-dot.failed { background: var(--error); }
        .status-dot.pending { background: var(--text-muted); }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
        }

        /* Auth */
        .auth-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
        .auth-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .auth-box input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
            margin-bottom: 16px;
        }
        .auth-box button {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        .auth-error { color: var(--error); font-size: 13px; margin-top: 12px; display: none; }

        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 16px; align-items: flex-start; }
            .charts-grid { grid-template-columns: 1fr; }
            .chart-stats { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <!-- Auth -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-box">
            <h2 style="margin-bottom:8px;">üîê ETHval Admin</h2>
            <p style="color:var(--text-muted);font-size:14px;margin-bottom:24px;">Enter password to access</p>
            <input type="password" id="adminPassword" placeholder="Password" onkeypress="if(event.key==='Enter')checkPassword()">
            <button onclick="checkPassword()">Unlock</button>
            <p class="auth-error" id="authError">Incorrect password</p>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üõ†Ô∏è ETHval Admin <span class="badge">DATA VERIFICATION</span></h1>
            <div class="header-actions">
                <div class="connection-status" id="connectionStatus">
                    <span style="width:6px;height:6px;border-radius:50%;background:currentColor;"></span>
                    <span id="connectionText">Connecting...</span>
                </div>
                <button class="btn btn-secondary" onclick="loadAllCharts()">üîÑ Refresh All</button>
                <button class="btn btn-primary" onclick="openGitHubActions()">‚ñ∂Ô∏è Run on GitHub</button>
            </div>
        </div>

        <div class="stats-summary">
            <div class="stat-card"><div class="label">Total Datasets</div><div class="value">8</div></div>
            <div class="stat-card"><div class="label">Success</div><div class="value success" id="successCount">-</div></div>
            <div class="stat-card"><div class="label">Partial</div><div class="value warning" id="partialCount">-</div></div>
            <div class="stat-card"><div class="label">Failed</div><div class="value error" id="failedCount">-</div></div>
            <div class="stat-card"><div class="label">Last Run</div><div class="value" id="lastRun" style="font-size:16px;">-</div></div>
        </div>

        <div class="charts-grid" id="chartsGrid"></div>
    </div>

    <script>
        const ADMIN_PASSWORD_HASH = 'ZXRodmFsYWRtaW4=';
        function checkPassword() {
            if (btoa(document.getElementById('adminPassword').value) === ADMIN_PASSWORD_HASH) {
                document.getElementById('authOverlay').style.display = 'none';
                sessionStorage.setItem('ethval_admin_auth', 'true');
            } else {
                document.getElementById('authError').style.display = 'block';
                document.getElementById('adminPassword').value = '';
            }
        }
        if (sessionStorage.getItem('ethval_admin_auth') === 'true') {
            document.getElementById('authOverlay').style.display = 'none';
        }

        const DATASETS = {
            'eth_price': { 
                name: 'ETH Price', 
                icon: 'üí∞', 
                table: 'historical_eth_price', 
                valueField: 'close', 
                dateField: 'date', 
                color: '#8b5cf6',
                format: 'price'
            },
            'ethereum_tvl': { 
                name: 'Ethereum TVL', 
                icon: 'üè¶', 
                table: 'historical_ethereum_tvl', 
                valueField: 'tvl', 
                dateField: 'date', 
                color: '#22c55e',
                format: 'tvl'
            },
            'l2_tvl': { 
                name: 'L2 TVL (All Chains)', 
                icon: 'üîó', 
                table: 'historical_l2_tvl', 
                valueField: 'tvl', 
                dateField: 'date', 
                color: '#3b82f6',
                format: 'tvl',
                aggregate: true  // Need to aggregate by date
            },
            'protocol_fees': { 
                name: 'Protocol Fees', 
                icon: 'üìà', 
                table: 'historical_protocol_fees', 
                valueField: 'total_fees', 
                dateField: 'date', 
                color: '#f59e0b',
                format: 'fees'
            },
            'staking_data': { 
                name: 'Staking Data', 
                icon: 'ü•©', 
                table: 'historical_staking', 
                valueField: 'total_staked_eth', 
                dateField: 'date', 
                color: '#ef4444',
                format: 'eth'
            },
            'gas_burn': { 
                name: 'Gas Price', 
                icon: 'üî•', 
                table: 'historical_gas_burn', 
                valueField: 'avg_gas_price_gwei', 
                dateField: 'date', 
                color: '#f97316',
                format: 'gas'
            },
            'active_addresses': { 
                name: 'Active Addresses', 
                icon: 'üë•', 
                table: 'historical_active_addresses', 
                valueField: 'active_addresses', 
                dateField: 'date', 
                color: '#06b6d4',
                format: 'number'
            },
            'eth_supply': { 
                name: 'ETH Supply', 
                icon: 'üíé', 
                table: 'historical_eth_supply', 
                valueField: 'eth_supply', 
                dateField: 'date', 
                color: '#a855f7',
                format: 'eth'
            }
        };

        let supabase = null;
        const charts = {};
        const SUPABASE_URL = 'https://rliwxedrifwxbudcutqs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJsaXd4ZWRyaWZ3eGJ1ZGN1dHFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MzU2MDQsImV4cCI6MjA4MDAxMTYwNH0.jX_tAdAhXEcmHdtf56-8La4SpqbKEM3_hIBBwhldD6Y';
        const DEFAULT_GITHUB_REPO = 'seojoonkim/eth-value';

        function openGitHubActions() {
            window.open(`https://github.com/${DEFAULT_GITHUB_REPO}/actions`, '_blank');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            createChartCards();
            await initSupabase();
        });

        function createChartCards() {
            const grid = document.getElementById('chartsGrid');
            grid.innerHTML = Object.entries(DATASETS).map(([key, ds]) => `
                <div class="chart-card" id="card-${key}">
                    <div class="chart-header">
                        <h3><span class="icon">${ds.icon}</span> ${ds.name}</h3>
                        <div class="chart-meta">
                            <span>Records: <span class="value" id="records-${key}">-</span></span>
                            <span>Range: <span class="value" id="range-${key}">-</span></span>
                            <span class="status-dot pending" id="status-${key}"></span>
                        </div>
                    </div>
                    <div class="chart-body">
                        <canvas id="chart-${key}"></canvas>
                        <div class="loading" id="loading-${key}">Loading...</div>
                    </div>
                    <div class="chart-stats">
                        <div class="chart-stat"><div class="label">Latest</div><div class="value latest" id="latest-${key}">-</div></div>
                        <div class="chart-stat"><div class="label">Min</div><div class="value min" id="min-${key}">-</div></div>
                        <div class="chart-stat"><div class="label">Max</div><div class="value max" id="max-${key}">-</div></div>
                        <div class="chart-stat"><div class="label">Average</div><div class="value" id="avg-${key}">-</div></div>
                    </div>
                </div>
            `).join('');
        }

        async function initSupabase() {
            try {
                document.getElementById('connectionStatus').className = 'connection-status disconnected';
                document.getElementById('connectionText').textContent = 'Connecting...';
                
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                const { error } = await supabase.from('data_collection_status').select('count').limit(1);
                if (error) throw error;
                
                document.getElementById('connectionStatus').className = 'connection-status connected';
                document.getElementById('connectionText').textContent = 'Connected';
                
                await loadStatus();
                await loadAllCharts();
            } catch (e) {
                document.getElementById('connectionStatus').className = 'connection-status disconnected';
                document.getElementById('connectionText').textContent = 'Failed';
                console.error(e);
            }
        }

        async function loadStatus() {
            try {
                const { data, error } = await supabase.from('data_collection_status').select('*');
                if (error) throw error;
                
                let success = 0, partial = 0, failed = 0, lastRun = null;
                const statusMap = {};
                
                data.forEach(s => {
                    statusMap[s.dataset_name] = s;
                    if (s.status === 'success') success++;
                    else if (s.status === 'partial') partial++;
                    else if (s.status === 'failed') failed++;
                    if (s.last_run_at && (!lastRun || new Date(s.last_run_at) > new Date(lastRun))) {
                        lastRun = s.last_run_at;
                    }
                    
                    // Update status dot
                    const dot = document.getElementById(`status-${s.dataset_name}`);
                    if (dot) {
                        dot.className = `status-dot ${s.status || 'pending'}`;
                    }
                });
                
                document.getElementById('successCount').textContent = success;
                document.getElementById('partialCount').textContent = partial;
                document.getElementById('failedCount').textContent = failed;
                document.getElementById('lastRun').textContent = lastRun ? formatTime(lastRun) : 'Never';
                
            } catch (e) { console.error(e); }
        }

        async function loadAllCharts() {
            for (const key of Object.keys(DATASETS)) {
                await loadChartData(key);
            }
        }

        async function loadChartData(key) {
            const ds = DATASETS[key];
            const loadingEl = document.getElementById(`loading-${key}`);
            
            try {
                loadingEl.style.display = 'flex';
                
                let data;
                
                if (ds.aggregate) {
                    // For L2 TVL - aggregate by date
                    const { data: rawData, error } = await supabase
                        .from(ds.table)
                        .select(`${ds.dateField}, ${ds.valueField}`)
                        .order(ds.dateField, { ascending: false })
                        .limit(50000);  // Get more data for aggregation
                    
                    if (error) throw error;
                    
                    // Aggregate by date
                    const dateMap = new Map();
                    rawData.forEach(row => {
                        const date = row[ds.dateField];
                        const val = parseFloat(row[ds.valueField]) || 0;
                        dateMap.set(date, (dateMap.get(date) || 0) + val);
                    });
                    
                    data = Array.from(dateMap.entries())
                        .map(([date, tvl]) => ({ [ds.dateField]: date, [ds.valueField]: tvl }))
                        .sort((a, b) => a[ds.dateField].localeCompare(b[ds.dateField]));
                    
                } else {
                    // Normal fetch - get ALL data, not limited
                    const { data: rawData, error } = await supabase
                        .from(ds.table)
                        .select(`${ds.dateField}, ${ds.valueField}`)
                        .order(ds.dateField, { ascending: true });
                    
                    if (error) throw error;
                    data = rawData;
                }
                
                loadingEl.style.display = 'none';
                
                if (!data || data.length === 0) {
                    document.getElementById(`records-${key}`).textContent = '0';
                    document.getElementById(`range-${key}`).textContent = 'No data';
                    return;
                }
                
                // Update stats
                const values = data.map(d => parseFloat(d[ds.valueField]) || 0).filter(v => v > 0);
                const minVal = Math.min(...values);
                const maxVal = Math.max(...values);
                const avgVal = values.reduce((a, b) => a + b, 0) / values.length;
                const latestVal = values[values.length - 1];
                
                document.getElementById(`records-${key}`).textContent = data.length.toLocaleString();
                document.getElementById(`range-${key}`).textContent = 
                    `${data[0][ds.dateField]} ~ ${data[data.length - 1][ds.dateField]}`;
                
                document.getElementById(`latest-${key}`).textContent = formatValue(latestVal, ds.format);
                document.getElementById(`min-${key}`).textContent = formatValue(minVal, ds.format);
                document.getElementById(`max-${key}`).textContent = formatValue(maxVal, ds.format);
                document.getElementById(`avg-${key}`).textContent = formatValue(avgVal, ds.format);
                
                // Render chart
                renderChart(key, data, ds);
                
            } catch (e) {
                console.error(`Failed to load ${key}:`, e);
                loadingEl.textContent = 'Error loading data';
            }
        }

        function renderChart(key, data, ds) {
            const ctx = document.getElementById(`chart-${key}`).getContext('2d');
            
            if (charts[key]) {
                charts[key].destroy();
            }
            
            // Sample data for performance (max 500 points)
            const sampleRate = Math.max(1, Math.floor(data.length / 500));
            const sampled = data.filter((_, i) => i % sampleRate === 0);
            
            charts[key] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sampled.map(d => d[ds.dateField]),
                    datasets: [{
                        data: sampled.map(d => parseFloat(d[ds.valueField]) || 0),
                        borderColor: ds.color,
                        backgroundColor: ds.color + '15',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0,
                        borderWidth: 1.5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1a1a25',
                            titleColor: '#e5e5e5',
                            bodyColor: '#e5e5e5',
                            borderColor: '#2a2a3a',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: false,
                            callbacks: {
                                label: ctx => formatValue(ctx.raw, ds.format)
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#1a1a25' },
                            ticks: { 
                                color: '#666',
                                maxTicksLimit: 6,
                                maxRotation: 0,
                                font: { size: 10 }
                            }
                        },
                        y: {
                            grid: { color: '#1a1a25' },
                            ticks: { 
                                color: '#666',
                                font: { size: 10 },
                                callback: v => formatValueShort(v, ds.format)
                            }
                        }
                    }
                }
            });
        }

        function formatValue(val, format) {
            if (val === null || val === undefined || isNaN(val)) return '-';
            const n = parseFloat(val);
            
            switch (format) {
                case 'price':
                    return '$' + n.toLocaleString(undefined, { maximumFractionDigits: 2 });
                case 'tvl':
                case 'fees':
                    if (n >= 1e12) return '$' + (n / 1e12).toFixed(2) + 'T';
                    if (n >= 1e9) return '$' + (n / 1e9).toFixed(2) + 'B';
                    if (n >= 1e6) return '$' + (n / 1e6).toFixed(2) + 'M';
                    return '$' + n.toLocaleString();
                case 'eth':
                    if (n >= 1e9) return (n / 1e9).toFixed(2) + 'B ETH';
                    if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M ETH';
                    return n.toLocaleString() + ' ETH';
                case 'gas':
                    return n.toFixed(1) + ' Gwei';
                case 'number':
                    if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M';
                    if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
                    return n.toLocaleString();
                default:
                    return n.toLocaleString();
            }
        }

        function formatValueShort(val, format) {
            if (val === null || val === undefined || isNaN(val)) return '';
            const n = parseFloat(val);
            
            if (n >= 1e12) return (n / 1e12).toFixed(1) + 'T';
            if (n >= 1e9) return (n / 1e9).toFixed(1) + 'B';
            if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
            if (n >= 1e3) return (n / 1e3).toFixed(0) + 'K';
            
            if (format === 'price' || format === 'tvl' || format === 'fees') {
                return '$' + n.toFixed(0);
            }
            if (format === 'gas') return n.toFixed(0);
            
            return n.toFixed(0);
        }

        function formatTime(dateStr) {
            const diff = (new Date() - new Date(dateStr)) / 1000;
            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return `${Math.floor(diff / 86400)}d ago`;
        }
    </script>
</body>
</html>
